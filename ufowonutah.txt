-- Thg cho skidcode
local startTime = tick()

do
    local success, err = pcall(function()
        local player = game:GetService("Players").LocalPlayer
        local gui = Instance.new("ScreenGui")
        gui.Name = "AutoBondGUI"
        gui.ResetOnSpawn = false
        gui.Parent = player:WaitForChild("PlayerGui")

        -- Note góc trên
        local topNote = Instance.new("TextLabel")
        topNote.Text = "by XuanVP-IDK"
        topNote.Size = UDim2.new(0, 200, 0, 30)
        topNote.Position = UDim2.new(0, 10, 0, 30)
        topNote.BackgroundTransparency = 1
        topNote.TextColor3 = Color3.fromRGB(255, 255, 255)
        topNote.Font = Enum.Font.SourceSansBold
        topNote.TextSize = 18
        topNote.TextXAlignment = Enum.TextXAlignment.Left
        topNote.ZIndex = 2
        topNote.Parent = gui

        -- Nút Xuan Hub
        local btnXuan = Instance.new("TextButton")
        btnXuan.Text = "Copy Xuan Hub Discord"
        btnXuan.Size = UDim2.new(0, 180, 0, 36)
        btnXuan.Position = UDim2.new(1, -190, 0, 10)
        btnXuan.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        btnXuan.TextColor3 = Color3.fromRGB(255, 255, 255)
        btnXuan.Font = Enum.Font.SourceSansBold
        btnXuan.TextSize = 16
        btnXuan.ZIndex = 2
        btnXuan.Parent = gui

        btnXuan.MouseButton1Click:Connect(function()
            setclipboard("https://discord.gg/usv255Pw4t")
            btnXuan.Text = "Đã copy!"
            task.delay(1.5, function()
                btnXuan.Text = "Copy Xuan Hub Discord"
            end)
        end)

        -- Nút NyricX Hub
        local btnNyric = Instance.new("TextButton")
        btnNyric.Text = "Copy NyricX Hub Discord"
        btnNyric.Size = UDim2.new(0, 180, 0, 36)
        btnNyric.Position = UDim2.new(1, -190, 0, 56)
        btnNyric.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        btnNyric.TextColor3 = Color3.fromRGB(255, 255, 255)
        btnNyric.Font = Enum.Font.SourceSansBold
        btnNyric.TextSize = 16
        btnNyric.ZIndex = 2
        btnNyric.Parent = gui

        btnNyric.MouseButton1Click:Connect(function()
            setclipboard("https://discord.gg/eWKbt45GPc")
            btnNyric.Text = "Đã copy!"
            task.delay(1.5, function()
                btnNyric.Text = "Copy NyricX Hub Discord"
            end)
        end)

        -- Note tiếng Việt
        local noteVN = Instance.new("TextLabel")
        noteVN.Text = "• Bản auto bond này đôi khi vẫn có lỗi ở 1 số ván game.\n• Nếu có lỗi, hãy đợi chuyển sang ván mới nhé!"
        noteVN.Size = UDim2.new(0, 450, 0, 48)
        noteVN.Position = UDim2.new(0, 10, 1, -100)
        noteVN.BackgroundTransparency = 1
        noteVN.TextColor3 = Color3.new(1, 1, 1)
        noteVN.TextWrapped = true
        noteVN.TextXAlignment = Enum.TextXAlignment.Left
        noteVN.Font = Enum.Font.SourceSans
        noteVN.TextSize = 16
        noteVN.ZIndex = 2
        noteVN.Parent = gui

        -- Note tiếng Anh
        local noteEN = Instance.new("TextLabel")
        noteEN.Text = "• This auto bond script may encounter bugs in some game rounds.\n• If it happens, please wait for the next round!"
        noteEN.Size = UDim2.new(0, 450, 0, 48)
        noteEN.Position = UDim2.new(0, 10, 1, -50)
        noteEN.BackgroundTransparency = 1
        noteEN.TextColor3 = Color3.new(1, 1, 1)
        noteEN.TextWrapped = true
        noteEN.TextXAlignment = Enum.TextXAlignment.Left
        noteEN.Font = Enum.Font.SourceSans
        noteEN.TextSize = 16
        noteEN.ZIndex = 2
        noteEN.Parent = gui
    end)
    if not success then
        warn("Không thể tạo GUI: ", err)
    end
end

pcall(function()
    workspace.StreamingEnabled = false
    workspace.SimulationRadius = math.huge
end)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

-- Bất tử
humanoid.MaxHealth = math.huge
humanoid.Health = humanoid.MaxHealth

local healthConn = humanoid.HealthChanged:Connect(function(newHealth)
    if newHealth < humanoid.MaxHealth then
        humanoid.Health = humanoid.MaxHealth
    end
end)

local networkFolder = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Network")
local ActivatePromise = networkFolder.RemotePromise.Remotes.C_ActivateObject

local remotesRoot = ReplicatedStorage:WaitForChild("Remotes")
local EndDecisionRemote = remotesRoot:WaitForChild("EndDecision")

local bondData = {}
local seenKeys = {}

-- UI counter
local function createCounterUI()
    local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
    screenGui.Name = "BondCounterUI"
    local textLabel = Instance.new("TextLabel", screenGui)
    textLabel.Name = "Counter"
    textLabel.Size = UDim2.new(0, 200, 0, 40)
    textLabel.Position = UDim2.new(0, 10, 0, 40)
    textLabel.BackgroundTransparency = 0.5
    textLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 22
    textLabel.Text = "Bond: 0 / ?"
    return textLabel
end

local counterLabel = createCounterUI()

-- Ghi lại vị trí bond
local function recordBonds()
    local runtime = Workspace:WaitForChild("RuntimeItems")
    for _, item in ipairs(runtime:GetChildren()) do
        if item.Name:match("Bond") then
            local part = item.PrimaryPart or item:FindFirstChildWhichIsA("BasePart")
            if part then
                local key = ("%.1f_%.1f_%.1f"):format(part.Position.X, part.Position.Y, part.Position.Z)
                if not seenKeys[key] then
                    seenKeys[key] = true
                    table.insert(bondData, { item = item, pos = part.Position, key = key })
                end
            end
        end
    end
end

print("=== Starting map scan ===")

local function tweenTo(positionCFrame)
    local tweenInfo = TweenInfo.new(0.45, Enum.EasingStyle.Linear)
    local goal = { CFrame = positionCFrame }
    local tween = TweenService:Create(hrp, tweenInfo, goal)
    tween:Play()
    tween.Completed:Wait()
end

-- Scan map để tìm bond
local scanTarget = CFrame.new(-424.448975, 16.055481, -49040.6562, -1,0,0, 0,1,0, 0,0,-1)
local scanSteps = 50
for i = 1, scanSteps do
    local stepCFrame = hrp.CFrame:Lerp(scanTarget, i/scanSteps)
    tweenTo(stepCFrame)
    recordBonds()
    task.wait(0.09)
end

tweenTo(scanTarget)
task.wait(0.2)
recordBonds()

print(("→ %d Bonds found"):format(#bondData))
if #bondData == 0 then
    warn("Không tìm thấy bond nào – kiểm tra RuntimeItems.")
    return
end

counterLabel.Text = string.format("Bond: 0 / %d", #bondData)

-- Tìm MaximGun và ghế
local runtimeItems = workspace:WaitForChild("RuntimeItems")
local gun = runtimeItems:FindFirstChild("MaximGun")

if not gun or not gun:FindFirstChild("VehicleSeat") then
    warn("Không tìm thấy MaximGun, thử lại lần 2...")
    task.wait(1)
    gun = runtimeItems:FindFirstChild("MaximGun")
    if not gun or not gun:FindFirstChild("VehicleSeat") then
        warn("Lần 2 vẫn không tìm được MaximGun – tự sát đợi ván mới.")
        
        -- Gỡ bất tử và tự sát
        if healthConn then healthConn:Disconnect() end
        humanoid.MaxHealth = 100
        humanoid.Health = 100
        task.wait(0.2)
        humanoid:TakeDamage(999999)
        EndDecisionRemote:FireServer(false)
        return
    end
end

local seat = gun.VehicleSeat
char:SetPrimaryPartCFrame(seat.CFrame + Vector3.new(0, 3, 0))
task.wait(0.3)
seat:Sit(humanoid)
repeat task.wait() until humanoid.SeatPart == seat
humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
task.delay(0.05, function()
    seat:Sit(humanoid)
end)

-- Nghe phím space
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Space and humanoid.SeatPart == seat then
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        task.delay(0.1, function()
            seat:Sit(humanoid)
        end)
    end
end)

-- Lụm bond và xử lý rollback
for idx, entry in ipairs(bondData) do
    print(("--- Bond %d/%d: %s ---"):format(idx, #bondData, entry.key))
    local targetCFrame = CFrame.new(entry.pos) * CFrame.new(0, 2, 0)

    seat:PivotTo(targetCFrame)
    task.wait(0.25)

    -- Check rollback
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    if dist > 8 then
        print("Bị TP ngược, nhảy và ngồi lại.")
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        task.wait(0.2)
        seat:Sit(humanoid)
        task.wait(0.2)
        seat:PivotTo(targetCFrame)
        task.wait(0.25)
    end

    if humanoid.SeatPart ~= seat then
        seat:Sit(humanoid)
        task.wait(0.2)
    end

    if entry.item and entry.item.Parent then
        ActivatePromise:FireServer(entry.item)
        task.wait(0.35)
    end

    counterLabel.Text = string.format("Bond: %d / %d", idx, #bondData)
end

-- Kết thúc ván: Gỡ bất tử và tự sát
if healthConn then healthConn:Disconnect() end
humanoid.MaxHealth = 100
humanoid.Health = 100
task.wait(0.2)
humanoid:TakeDamage(999999)
EndDecisionRemote:FireServer(false)
print("=== Xong xuôi rồi đấy, đợi ván mới thôi ===")

-- Chuẩn Bị tin nhắn webhook khi tất cả bond đã nhặt
local duration = tick() - startTime
local totalBonds = #bondData

-- Tùy: Tạo Thông Tin  string như: "Bond 1", "Bond 2", vân vân
local progressList = {}
for i = 1, totalBonds do
    table.insert(progressList, string.format("Bond %d", i))
end
local progressText = table.concat(progressList, ", ")

-- tạo embed
local data = {
    ["embeds"] = {
        {
            ["title"] = " Nhặt Bond Thành Công.",
            ["description"] = string.format("Nhặt Được  **%d** bonds trong **%.2f seconds**.", totalBonds, duration),
            ["color"] = 3066993, -- Green
            ["fields"] = {
                {
                    ["name"] = "Progress",
                    ["value"] = progressText:sub(1, 1024) -- Discord embed field limit
                }
            },
            ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ"),
            ["footer"] = {
                ["text"] = "Bond Collect By XuanVP-Idk"
            }
        }
    },
    ["username"] = "XuanVP"
}

-- Send webhook
local headers = {
    ["Content-Type"] = "application/json"
}
local body = game:GetService("HttpService"):JSONEncode(data)

if syn and syn.request then
    syn.request({Url = _G.url, Method = "POST", Headers = headers, Body = body})
elseif http and http.request then
    http.request({Url = _G.url, Method = "POST", Headers = headers, Body = body})
elseif request then
    request({Url = _G.url, Method = "POST", Headers = headers, Body = body})
else
    warn("No HTTP request method available.")
end



